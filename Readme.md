## 비동기, 동시성

### 1. 동시성 유형

- 병렬 컴퓨팅(parallel computing): 하나의 작업을 여러 개의 전용 CPU에 동시에 분산한다. 이는 화면 구현이나 머신 러닝 같은 '숫자 처리' 애플리케이션에서 보편적으로 사용한다.
- 동시 컴퓨팅(concurrent computing): 각 CPU가 여러 작업을 전환한다. 다른 작업보다 오래 걸리는 작업이 있기 마련이며, 우리가 원하는 것은 총시간의 감소다. 파일 읽기, 원격 네트워크 서비스 접속은 CPU에서 계산을 실행하는 것보다 수천에서 수만 배 느리다.

#### 1.1 운영 체제 프로세스

운영 체제는 메모리, CPU, 장치, 네트워크 등의 자원 사용을 조율한다. 모든 프로그램은 코드를 하나 이상의 프로세스에서 실행한다. OS는 각 프로세스가 CPU 사용 시점을 비롯해 자원에 접근을 제한해 관리한다.

시스템은 대부분 선점형(preemptive) 프로세스 스케줄링을 사용해 특정 프로세스가 CPU, 메모리, 기타 자원을 독점하지 못하게 한다. OS는 주어진 설계와 설정에 따라 프로세스를 중지하거나 재시작한다.

개발자에게 좋은 소식은 여러분은 이 문제에 관여할 수 없다는 점이다. 하지만 나쁜 소식은 여러분이 바꾸고 싶어도 바꿀 수 없다는 것이다. CPU 집약적인 파이썬 애플리케이션에서 흔한 해결책은 여러 개의 프로세스를 실행시키고 OS가 관리하도록 맡기는 것이다. 파이썬은 이를 위해 multiprocessing 모듈을 제공한다.


#### 1.2 운영 체제 스레드

단일 프로세스에서 여러 개의 스레드를 제언할 수도 있다. 파이썬의 쓰레딩(threading) 모듈이 이를 관리한다.

프로그램이 I/O에 바인딩되는 경우 스레드를, CPU에 바인되는 경우 다중 프로세스를 사용하길 추천한다. 하지만 스레드는 프로그램하기 까다롭고 찾기 어려운 오류를 유발할 수 있다.

#### 1.3 콜백

함수를 작성해 특정 이벤트(예: 마우스 클릭, 키 눌림, 시간)에 연결한다. 이런 범주에서 제일 유명한 라이브러리는 콜백 기반으로 구현한 twisted다.

#### 1.4 파이썬 제너레이터

대부분의 프로그래밍 언어처럼 파이썬도 코드를 순차적으로 실행한다. 함수를 호출하면 파이썬은 코드를 첫 줄부터 끝 줄이나 return이 나올 때까지 실행한다.

하지만 파이썬 '제너레이터 함수'는 원하는 곳에서 멈추고 어느 곳에서든 `return`을 하거나 `yield` 키워드를 사용해 다시 그 지점으로 돌아갈 수 있다.

```python
# return 사용
def doh():
    return ["Hommer: D'oh!", "Lisa: A deer!", "Marge: Afemale deer!"]

for line in doh():
    print(line)
```

코드가 비교적 작아서 큰 무리 없이 동작한다. 하지만, 리스트는 메모리를 사용한다.

```python
# yield 사용
def doh2():
    yield "Homer: D'oh!"
    yield "Lisa: A deer!"
    yield "Marge: A female deer!"

for line in doh2():
    # 첫 대사를 반환하고 다음 순회에서 반환할 대상을 파악
    print(line)
```

`yield` 키워드를 가진 함수는 전부 제너레이터 함수다. 함수 코드 중간에 다시 돌아가고 실행을 재개하는 방법을 배웠다.

#### 1.5 파이썬의 async, await, asyncio


```python
import time
def q():
     print("시트웰: 답이 하나도 안 맞잖아?")
     time.sleep(3)
 
def a():
     print("로저스: 하지만 빨랐죠.")
 
def main():
     q()
     a()
 
main()
# 첫 문장과 다음 문장 사이에 3초 시간이 걸린다.
```

```python
import asyncio

async def q():
     print("시트웰: 답이 하나도 안 맞잖아?")
     await asyncio.sleep(3)
 
async def a():
     print("로저스: 하지만 빨랐죠.")
 
async def main():
     await asyncio.gather(q(), a())
 
asyncio.run(main())
# 두 문장 모두 바로 출력 후, 3초 정적 
```

### 2. FastAPI와 Async

FastAPI는 비동기 경로 함수를 조율하는 비동기 이벤트 루프와 동기 경로 함수를 위한 스레드풀을 가지고 있다. 개발자가 까다로운 세부 사항을 알 필요가 없다는 점이 FastAPI의 커다란 장점이다. 예를 들어, 앞의 코드에서 `asyncio.gather()` 또는 `asyncio.run()` 같은 메서드를 실행할 필요가 없다.

## Pydantic과 타입 힌트, 모델

### 1. 타입 힌트

- `Any`: 모든 타입
- `Union`: `Union[str, int]`와 같이 지정된 모든 타입
  - 파이썬 3.10 이상에서는 `Union[type1, type2]` == `type1` | `type2` 형태로 작성 가능 

### 2. 데이터 그룹화

파이썬 클래스로 데이터를 그룹화하면 모든 어트리뷰트를 `self`로 추가한다. 이 단순한 작업에 많은 타이핑이 필요하다. 

다른 언어에서 레코드(record) 또는 구조체(struct)라고 부르는 것과 유사한 것으로 파이썬에는 데이터클래스(dataclass)가 있다.

### 3. 대안

- Dataclasses
- attrs
- Pydantic
  - 필수 사항과 선택 사항
  - 지정되지 않았지만 필요한 경우 기본값
  - 예상되는 하나 이상의 데이터 타입
  - 값 범위 제한
  - 필요한 경우 기타 기능 기반 검사
  - 직렬화 역직렬화 